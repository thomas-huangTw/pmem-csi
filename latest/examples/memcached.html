

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>memcached &mdash; PMEM-CSI  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script src="../_static/clipboard.min.js"></script>
        <script src="../_static/copybutton.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Google Cloud Engine" href="gce.html" />
    <link rel="prev" title="Redis-pmem operator" href="redis-operator.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> PMEM-CSI
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../README.html">Introduction to PMEM-CSI for Kubernetes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../docs/design.html">Design and architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../docs/install.html">Installation and Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../docs/DEVELOPMENT.html">Develop and contribute</a></li>
<li class="toctree-l1"><a class="reference internal" href="../docs/autotest.html">Automated testing</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="readme.html">Application examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="redis-operator.html">Redis-pmem operator</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">memcached</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#prerequisites">Prerequisites</a></li>
<li class="toctree-l3"><a class="reference internal" href="#pmem-as-dram-replacement">PMEM as DRAM replacement</a></li>
<li class="toctree-l3"><a class="reference internal" href="#restartable-cache">Restartable Cache</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="gce.html">Google Cloud Engine</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/intel/pmem-csi">Project GitHub repository</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">PMEM-CSI</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="readme.html">Application examples</a> &raquo;</li>
        
      <li>memcached</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="memcached">
<h1>memcached<a class="headerlink" href="#memcached" title="Permalink to this headline">¶</a></h1>
<p>As shown in <a class="reference external" href="https://memcached.org/blog/persistent-memory/">this blog
post</a>, memcached can
efficiently utilize PMEM as replacement for DRAM. This makes it
possible to increase cache sizes and/or reduce costs. The memcached
maintainers make container images available which support this
feature. This example shows how to take advantage of PMEM with
memcached running on Kubernetes.</p>
<div class="section" id="prerequisites">
<h2>Prerequisites<a class="headerlink" href="#prerequisites" title="Permalink to this headline">¶</a></h2>
<p>The instructions below assume that:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">kubectl</span></code> is available and can access the cluster.</p></li>
<li><p>PMEM-CSI <a class="reference external" href="/docs/install.html#installation-and-setup">was installed</a>
with the default <code class="docutils literal notranslate"><span class="pre">pmem-csi.intel.com</span></code> driver name and with the
<a class="reference external" href="https://github.com/intel/pmem-csi/blob/a68bff506c44c5fc5d759f8b3303cdc2d36c80e4/deploy/common/pmem-storageclass-ext4.yaml"><code class="docutils literal notranslate"><span class="pre">pmem-csi-sc-ext4</span></code> storage
class</a>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">telnet</span></code> or similar tools like <code class="docutils literal notranslate"><span class="pre">socat</span></code> are available.</p></li>
</ul>
<p>It is not necessary to check out the PMEM-CSI source code.</p>
</div>
<div class="section" id="pmem-as-dram-replacement">
<h2>PMEM as DRAM replacement<a class="headerlink" href="#pmem-as-dram-replacement" title="Permalink to this headline">¶</a></h2>
<p>Memcached can map PMEM into its address space and then store the bulk
of the cache there. The advantage is higher capacity and (depending on
pricing) less costs.</p>
<p>The cache could be stored in a persistent volume and reused after a
restart (see next section), but when that isn’t the goal, a
<a class="reference external" href="https://github.com/intel/pmem-csi/blob/a68bff506c44c5fc5d759f8b3303cdc2d36c80e4/deploy/kustomize/memcached/ephemeral/memcached-ephemeral.yaml">deployment with one CSI ephemeral inline
volume</a>
per memcached pod is very simple:</p>
<ul class="simple">
<li><p>A Kubernetes deployment manages the memcached instance(s).</p></li>
<li><p>In the pod template, one additional PMEM volume of a certain size is
requested.</p></li>
<li><p>An init container prepares that volume for use by memcached:</p>
<ul>
<li><p>It determines how large the actual file can be that memcached will use.</p></li>
<li><p>It changes volume ownership so that memcached can run as non-root
process.</p></li>
</ul>
</li>
<li><p>A wrapper script adds the <code class="docutils literal notranslate"><span class="pre">--memory-file</span></code> and <code class="docutils literal notranslate"><span class="pre">--memory-limit</span></code> parameters
when invoking memcached, which enables the use of PMEM.</p></li>
</ul>
<p>In this mode, the PMEM-CSI driver is referenced through its name
(usually <code class="docutils literal notranslate"><span class="pre">pmem-csi.intel.com</span></code>). No storage classes are needed. That
name and other parameters in the deployment can be modified with
<a class="reference external" href="https://github.com/kubernetes-sigs/kustomize"><code class="docutils literal notranslate"><span class="pre">kustomize</span></code></a>. Here’s
how one can change the namespace, volume size or add additional
command line parameters:</p>
<div class="highlight-ShellSession notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> mkdir -p my-memcached-deployment

<span class="gp">$</span> cat &gt;my-memcached-deployment/kustomization.yaml &lt;&lt;EOF
<span class="go">namespace: demo</span>
<span class="go">bases:</span>
<span class="go"> - github.com/intel/pmem-csi/deploy/kustomize/memcached/ephemeral</span>?ref=a68bff506c44c5fc5d759f8b3303cdc2d36c80e4
<span class="go">patchesStrategicMerge:</span>
<span class="go">- update-deployment.yaml</span>
<span class="go">EOF</span>

<span class="gp">$</span> cat &gt;my-memcached-deployment/update-deployment.yaml &lt;&lt;EOF
<span class="go">apiVersion: apps/v1</span>
<span class="go">kind: Deployment</span>
<span class="go">metadata:</span>
<span class="go">  name: pmem-memcached</span>
<span class="go">spec:</span>
<span class="go">  template:</span>
<span class="go">    spec:</span>
<span class="go">      containers:</span>
<span class="go">      - name: memcached</span>
<span class="go">        env:</span>
<span class="go">        - name: MEMCACHED_ARGS</span>
<span class="go">          value: --conn-limit=500</span>
<span class="go">      volumes:</span>
<span class="go">      - name: data-volume</span>
<span class="go">        csi:</span>
<span class="go">          volumeAttributes:</span>
<span class="go">            size: 500Mi</span>
<span class="go">EOF</span>
</pre></div>
</div>
<p>These commands then create the namespace and the deployment:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> kubectl create ns demo
<span class="go">namespace/demo created</span>
<span class="gp">$</span> kubectl create --kustomize my-memcached-deployment
<span class="go">service/pmem-memcached created</span>
<span class="go">deployment.apps/pmem-memcached created</span>
</pre></div>
</div>
<p>Eventually, there will be one pod with memcached running:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> kubectl <span class="nb">wait</span> --for<span class="o">=</span><span class="nv">condition</span><span class="o">=</span>Ready -n demo pods -l app.kubernetes.io/name<span class="o">=</span>pmem-memcached
<span class="go">pod/pmem-memcached-96f6b5986-hdx6n condition met</span>
</pre></div>
</div>
<p>How to access a service from remote varies between cluster
installations and how they handle incoming connections. Therefore we
use <a class="reference external" href="https://kubernetes.io/docs/tasks/access-application-cluster/port-forward-access-application-cluster/"><code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">port-forward</span></code></a>
to access the service. Run this command in one shell and keep it
running there:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> kubectl port-forward -n demo service/pmem-memcached <span class="m">11211</span>
<span class="go">Forwarding from 127.0.0.1:11211 -&gt; 11211</span>
<span class="go">Forwarding from [::1]:11211 -&gt; 11211</span>
</pre></div>
</div>
<p>In another shell we can now use <code class="docutils literal notranslate"><span class="pre">telnet</span></code> to connect to memcached:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> telnet localhost <span class="m">11211</span>
<span class="go">Trying ::1...</span>
<span class="go">Connected to localhost.</span>
<span class="go">Escape character is &#39;^]&#39;.</span>
</pre></div>
</div>
<p>Memcached accepts simple plain-text commands. To set a key with 10
characters, a time-to-live of 500 seconds and default flags, enter:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">set</span> <span class="n">demo_key</span> <span class="mi">0</span> <span class="mi">500000</span> <span class="mi">10</span>
<span class="n">I</span> <span class="n">am</span> <span class="n">PMEM</span><span class="o">.</span>
</pre></div>
</div>
<p>Memcached acknowledges this with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">STORED</span>
</pre></div>
</div>
<p>We can verify that the key exists with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">get</span> <span class="n">demo_key</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">VALUE</span> <span class="n">demo_key</span> <span class="mi">0</span> <span class="mi">10</span>
<span class="n">I</span> <span class="n">am</span> <span class="n">PMEM</span><span class="o">.</span>
<span class="n">END</span>
</pre></div>
</div>
<p>To disconnect, use:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">quit</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Connection</span> <span class="n">closed</span> <span class="n">by</span> <span class="n">foreign</span> <span class="n">host</span><span class="o">.</span>
</pre></div>
</div>
<p>The following command verifies the data was stored in a persistent
memory data volume:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> kubectl <span class="nb">exec</span> -n demo <span class="k">$(</span>kubectl get -n demo pods -l app.kubernetes.io/name<span class="o">=</span>pmem-memcached -o <span class="nv">jsonpath</span><span class="o">={</span>..metadata.name<span class="o">}</span><span class="k">)</span> grep <span class="s1">&#39;I am PMEM.&#39;</span> /data/memcached-memory-file
<span class="go">Binary file /data/memcached-memory-file matches</span>
</pre></div>
</div>
<p>To clean up, terminate the <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">port-forward</span></code> command and delete the memcached deployment with:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> kubectl delete --kustomize my-memcached-deployment
<span class="go">service &quot;pmem-memcached&quot; deleted</span>
<span class="go">deployment.apps &quot;pmem-memcached&quot; deleted</span>
</pre></div>
</div>
</div>
<div class="section" id="restartable-cache">
<h2>Restartable Cache<a class="headerlink" href="#restartable-cache" title="Permalink to this headline">¶</a></h2>
<p>The <a class="reference external" href="https://github.com/memcached/memcached/wiki/WarmRestart">restartable cache
feature</a>
works like non-persistent usage of PMEM. In addition, memcached writes
out one additional, short state file during a shutdown triggered by
<code class="docutils literal notranslate"><span class="pre">SIGUSR1</span></code>. The state file describes the content of the memory file and
is used during a restart by memcached to decide whether it can use the
existing cached data.</p>
<p>The <a class="reference external" href="https://github.com/intel/pmem-csi/blob/a68bff506c44c5fc5d759f8b3303cdc2d36c80e4/deploy/kustomize/memcached/persistent/memcached-persistent.yaml">example
deployment</a>
uses a stateful set because that can automatically create persistent
volumes for each instance. The shell wrapper around memcached
translates the normal <a class="reference external" href="https://kubernetes.io/docs/concepts/workloads/pods/pod/#termination-of-pods"><code class="docutils literal notranslate"><span class="pre">SIGTERM</span></code> shutdown
signal</a>
into <code class="docutils literal notranslate"><span class="pre">SIGUSR1</span></code>.</p>
<p>Deploying like that becomes less flexible because the memcached pods
can no longer move freely between nodes. Instead, each pod has to be
restarted on the node where its volume was created. There are also
<a class="reference external" href="https://github.com/memcached/memcached/wiki/WarmRestart#caveats">several caveats for memcached in this
mode</a>
that admins and application developers must be aware of.</p>
<p>This example can also be kustomized. It uses the <a class="reference external" href="https://github.com/intel/pmem-csi/blob/a68bff506c44c5fc5d759f8b3303cdc2d36c80e4/deploy/common/pmem-storageclass-ext4.yaml"><code class="docutils literal notranslate"><span class="pre">pmem-csi-sc-ext4</span></code>
storage class</a>. Here we
just use the defaults, in particular the default namespace:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> kubectl apply --kustomize github.com/intel/pmem-csi/deploy/kustomize/memcached/persistent?ref=a68bff506c44c5fc5d759f8b3303cdc2d36c80e4
<span class="go">service/pmem-memcached created</span>
<span class="go">statefulset.apps/pmem-memcached created</span>
</pre></div>
</div>
<p>We can verify that memcached really does a warm restart by storing
some data, removing the instance and then starting it again.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> kubectl <span class="nb">wait</span> --for<span class="o">=</span><span class="nv">condition</span><span class="o">=</span>Ready pods -l app.kubernetes.io/name<span class="o">=</span>pmem-memcached
<span class="go">pod/pmem-memcached-0 condition met</span>
</pre></div>
</div>
<p>Because we use a stateful set, the pod name is deterministic.</p>
<p>There is also a corresponding persistent volume:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> kubectl get pvc
<span class="go">NAME                                     STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS       AGE</span>
<span class="go">memcached-data-volume-pmem-memcached-0   Bound    pvc-bb2cde11-6aa2-46da-8521-9bc35c08426d   200Mi      RWO            pmem-csi-sc-ext4   5m45s</span>
</pre></div>
</div>
<p>First set a key using the same approach as before:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> kubectl port-forward service/pmem-memcached <span class="m">11211</span>
<span class="go">Forwarding from 127.0.0.1:11211 -&gt; 11211</span>
<span class="go">Forwarding from [::1]:11211 -&gt; 11211</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> telnet localhost <span class="m">11211</span>
<span class="go">Trying ::1...</span>
<span class="go">Connected to localhost.</span>
<span class="go">Escape character is &#39;^]&#39;.</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">set</span> <span class="n">demo_key</span> <span class="mi">0</span> <span class="mi">500000</span> <span class="mi">10</span>
<span class="n">I</span> <span class="n">am</span> <span class="n">PMEM</span><span class="o">.</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">STORED</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">quit</span>
</pre></div>
</div>
<p>Then scale down the number of memcached instances down to zero, then
restart it. To avoid race conditions, it is important to wait for
Kubernetes to catch up:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> kubectl scale --replicas<span class="o">=</span><span class="m">0</span> statefulset/pmem-memcached
<span class="go">statefulset.apps/pmem-memcached scaled</span>

<span class="gp">$</span> kubectl <span class="nb">wait</span> --for delete pod/pmem-memcached-0
<span class="go">Error from server (NotFound): pods &quot;pmem-memcached-0&quot; not found</span>

<span class="gp">$</span> kubectl scale --replicas<span class="o">=</span><span class="m">1</span> statefulset/pmem-memcached
<span class="go">statefulset.apps/pmem-memcached scaled</span>

<span class="gp">$</span> kubectl <span class="nb">wait</span> --for<span class="o">=</span><span class="nv">condition</span><span class="o">=</span>Ready pods -l app.kubernetes.io/name<span class="o">=</span>pmem-memcached
<span class="go">pod/pmem-memcached-0 condition met</span>
</pre></div>
</div>
<p>Restart the port forwarding now because it is tied to the previous pod.</p>
<p>Without the persistent volume and the restartable cache, the memcached
cache would be empty now. With <code class="docutils literal notranslate"><span class="pre">telnet</span></code> we can verify that this is not
the case and that the key is still known:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> telnet <span class="m">127</span>.0.0.1 <span class="m">11211</span>
<span class="go">Trying 127.0.0.1...</span>
<span class="go">Connected to 127.0.0.1.</span>
<span class="go">Escape character is &#39;^]&#39;.</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">get</span> <span class="n">demo_key</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">VALUE</span> <span class="n">demo_key</span> <span class="mi">0</span> <span class="mi">10</span>
<span class="n">I</span> <span class="n">am</span> <span class="n">PMEM</span><span class="o">.</span>
<span class="n">END</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">quit</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Connection</span> <span class="n">closed</span> <span class="n">by</span> <span class="n">foreign</span> <span class="n">host</span><span class="o">.</span>
</pre></div>
</div>
<p>To clean up, terminate the <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">port-forward</span></code> command and delete the memcached deployment with:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> kubectl delete --kustomize github.com/intel/pmem-csi/deploy/kustomize/memcached/persistent?ref=a68bff506c44c5fc5d759f8b3303cdc2d36c80e4
<span class="go">service &quot;pmem-memcached&quot; deleted</span>
<span class="go">statefulset.apps &quot;pmem-memcached&quot; deleted</span>
</pre></div>
</div>
<p>Beware that at the moment, the volumes need to be removed manually
after removing the stateful set. A <a class="reference external" href="https://github.com/kubernetes/kubernetes/issues/55045">request to automate
that</a> is open.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> kubectl delete pvc -l app.kubernetes.io/name<span class="o">=</span>pmem-memcached
<span class="go">persistentvolumeclaim &quot;memcached-data-volume-pmem-memcached-0&quot; deleted</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="gce.html" class="btn btn-neutral float-right" title="Google Cloud Engine" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="redis-operator.html" class="btn btn-neutral float-left" title="Redis-pmem operator" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019,

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>